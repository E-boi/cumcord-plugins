(function(F,a,u,n,p,h,R,S){"use strict";function k(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(s){if(s!=="default"){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}}),t.default=e,Object.freeze(t)}var r=k(F);const[{generateMessageSpecs:V,default:$}]=a.batchFind(e=>{e.findByProps("generateMessageSpecs")});var j=({amount:e})=>{const[t,s]=r.useState(null);return r.useEffect(()=>{s(V({compact:!1,fontSize:16,messageGroups:e,groupSpacing:16,groupRange:3}))},[]),t?r.createElement($,{compact:!1,messages:t.messages,attachmentSpecs:t.attachmentSpecs,totalHeight:t.totalHeight,groupSpacing:t.groupSpacing}):null};const[{default:z},{getMessages:A,getMessage:B},{fetchMessages:H},{divider:q,hasContent:W,content:Y},{divider:Z},{MessageDisplayCompact:b},J,{thin:K},{tabBar:Q,tabBarItem:w},{DEFAULT_COMPACT_SPACING:X,DEFAULT_COZY_SPACING:ee},{EmptyStateText:te,default:se},re,ne,m]=a.batchFind(e=>{e.findByProps("ThreadStarterChatMessage"),e.findByProps("getMessages"),e.findByProps("sendBotMessage"),e.findByProps("divider","isUnread"),e.findByProps("divider","hasContent"),e.findByProps("MessageDisplayCompact"),e.findByProps("messageGroupSpacing"),e.findByProps("thin"),e.findByProps("tabBar","tabBarItem"),e.findByProps("MESSAGE_GROUP_SPACING"),e.findByProps("EmptyStateText"),e.findByDisplayName("FluxContainer(TypingUsers)"),e.findByDisplayName("ActiveThreadsPopout"),e.findByDisplayName("TabBar")}),oe=p.constants.MESSAGE_GROUP_INTERVAL/1e3,P=p.constants.MessageTypes;let T;class ie extends r.PureComponent{constructor(t){super(),this.ref=r.createRef();const s=A(t.channel.id);this.state={messages:s.length===0&&s.ready?null:s.toArray().reverse().slice(0,20).reverse(),tab:"MESSAGES"},this.MESSAGE_CREATE=this.MESSAGE_CREATE.bind(this),this.MESSAGE_UPDATE=this.MESSAGE_UPDATE.bind(this),this.MESSAGE_DELETE=this.MESSAGE_DELETE.bind(this),this.scrollToBottom=this.scrollToBottom.bind(this)}componentDidMount(){this.state.messages?.length===0?H({channelId:this.props.channel.id,limit:20}).then(t=>{if(!t)return this.setState({messages:null});const s=A(this.props.channel.id).toArray().reverse().slice(0,20).reverse();if(s.length===0)return this.setState({messages:null});this.setState({messages:s}),this.scrollToBottom()}):this.scrollToBottom(),p.FluxDispatcher.subscribe("MESSAGE_CREATE",this.MESSAGE_CREATE),p.FluxDispatcher.subscribe("MESSAGE_UPDATE",this.MESSAGE_UPDATE),p.FluxDispatcher.subscribe("MESSAGE_DELETE",this.MESSAGE_DELETE)}componentWillUnmount(){p.FluxDispatcher.unsubscribe("MESSAGE_CREATE",this.MESSAGE_CREATE),p.FluxDispatcher.unsubscribe("MESSAGE_UPDATE",this.MESSAGE_UPDATE),p.FluxDispatcher.unsubscribe("MESSAGE_DELETE",this.MESSAGE_DELETE)}MESSAGE_CREATE(t){this.props.channel.id===t.channelId&&(this.setState(s=>({messages:[...s.messages,B(this.props.channel.id,t.message.id)]})),this.scrollToBottom())}MESSAGE_UPDATE(t){this.props.channel.id===t.message.channel_id&&this.setState(s=>{const i=s.messages.findIndex(o=>o.id===t.message.id);if(!(i<0))return s[i]=B(channel.id,t.message.id),s})}scrollToBottom(){this.ref.current&&(this.ref.current.scrollTop=this.ref.current.scrollHeight)}MESSAGE_DELETE(t){this.props.channel.id===t.channelId&&this.setState(s=>{const i=s.messages.findIndex(o=>o.id===t.id);if(!(i<0))return delete s.messages[i],{...t,messages:[...s.messages.filter(o=>o)]}})}getGroupId(t){const s=this.state.messages.indexOf(t)===0?null:this.state.messages[this.state.messages.indexOf(t)-1];return s?t.author.id!==s.author.id||t.type!==P.DEFAULT||![P.DEFAULT,P.REPLY].includes(s.type)||Math.abs(s.timestamp.unix()-t.timestamp.unix())>oe||!t.timestamp.isSame(s.timestamp,"day")?T=t.id:T:T=t.id}sortMessages(){const{messages:t}=this.state,s=[];return t.forEach(i=>{const o=this.getGroupId(i),d=t.indexOf(i)===0?null:t[t.indexOf(i)-1];(!d||!i.timestamp.isSame(d.timestamp,"day"))&&s.push(r.createElement(ae,{timestamp:i.timestamp}));const c=(n.persist.ghost.displayMode||"sync")==="sync"?b.getSetting():n.persist.ghost.displayMode==="compact";s.push(r.createElement(z,{compact:c,channel:this.props.channel,message:i,groupId:o,id:`chat-messages-${i.id}`}))}),s}renderMessagesPopout(){const t=(n.persist.ghost.displayMode||"sync")==="sync"?b.getSetting():n.persist.ghost.displayMode==="compact",s=n.persist.ghost.groupSpacing??"sync"?J.messageGroupSpacing:n.persist.ghost.groupSpacingNum??t?X:ee;return r.createElement("div",{onMouseEnter:this.props.onMouseEnter,className:["cc-ChannelPreview",`group-spacing-${s}`,K].join(" "),ref:this.ref},this.state.messages?this.state.messages.length===0?r.createElement(j,{amount:10}):r.createElement("div",{className:"cc-ChannelPreviewTyping"},this.sortMessages(),(n.persist.ghost.typingUsers??!0)&&r.createElement(re,{channel:this.props.channel})):r.createElement(se,null,r.createElement(te,{note:"This channel has no messages"})))}renderThreadPopout(){return r.createElement("div",{className:"cc-ChannelPreviewThreadPopout"},r.createElement(ne,{...this.props.popout,channel:this.props.channel}))}renderContent(){if(this.state.tab==="MESSAGES")return this.renderMessagesPopout();if(this.state.tab==="THREADS")return this.renderThreadPopout()}render(){return r.createElement(r.Fragment,null,(n.persist.ghost.tabs??!0)&&r.createElement(m,{className:["cc-ChannelPreviewTabBar",Q].join(" "),selectedItem:this.state.tab,onItemSelect:t=>this.setState({tab:t}),look:m.Looks.BRAND,type:m.Types.TOP},r.createElement(m.Item,{className:w,id:"MESSAGES"},"Messages"),r.createElement(m.Item,{className:w,id:"THREADS"},"Threads")),this.renderContent())}}const ae=({timestamp:e})=>r.createElement("div",{className:[q,W,Z,"cc-ChannePreviewDivider"].join(" "),"aria-label":e.format("LL"),role:"separator"},r.createElement("span",{className:Y},e.format("LL"))),[v,{chat:N},{getChannel:le}]=a.batchFind(e=>{e.findByDisplayName("Popout"),e.findByProps("chat"),e.findByProps("getDMFromUserId")});class pe extends r.PureComponent{constructor(t){super(),this.state={show:!1},this.enterTimer=0,this.exitTimer=0,this.channel=le(t.channelId),this.nestUpdate=this.nestUpdate.bind(this),this.handleMouseEnter=this.handleMouseEnter.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handlePopoutOpen=this.handlePopoutOpen.bind(this)}nestUpdate(){this.forceUpdate()}componentDidMount(){try{n.persist.on(h.Events.UPDATE,this.nestUpdate),n.persist.on(h.Events.SET,this.nestUpdate),n.persist.on(h.Events.DELETE,this.nestUpdate)}catch{}}componentWillUnmount(){y(),n.persist.off(h.Events.UPDATE,this.nestUpdate),n.persist.off(h.Events.SET,this.nestUpdate),n.persist.off(h.Events.DELETE,this.nestUpdate)}handleMouseEnter(){this.resetPopoutTimers(),this.channel.id!==p.channels.getChannelId()&&(this.enterTimer=setTimeout(()=>{this.setState({show:!0}),setTimeout(()=>G())},(n.persist.ghost.delay||.3)*1e3))}handleMouseLeave(){this.resetPopoutTimers(),this.exitTimer=setTimeout(()=>{this.setState({show:!1}),y()},300)}handlePopoutClose(){this.resetPopoutTimers(),this.setState({show:!1}),y()}handlePopoutOpen(){this.resetPopoutTimers(),this.setState({show:!0}),setTimeout(()=>G(),this.state.show?300:0)}renderPopout(t){return r.createElement(ie,{popout:t,onMouseEnter:this.handlePopoutOpen,onClose:this.handlePopoutClose.bind(this),channel:this.channel})}resetPopoutTimers(){clearTimeout(this.enterTimer),clearTimeout(this.exitTimer)}render(){return(n.persist.ghost.displayOn||"hover")==="hover"?(this.props.res.props.onMouseEnter=this.handleMouseEnter,this.props.res.props.onMouseDown=null):(this.props.res.props.onMouseDown=t=>t.button===1&&this.handlePopoutOpen(),this.props.res.props.onMouseEnter=()=>this.state.show&&this.handlePopoutOpen()),this.props.res.props.onMouseLeave=this.handleMouseLeave,r.createElement(v,{nudgeAlignIntoViewport:!0,autoInvert:!0,renderPopout:this.renderPopout.bind(this),shouldShow:!!this.state.show,spacing:20,onRequestClose:this.handlePopoutClose.bind(this),align:v.Align.CENTER,animation:v.Animation.TRANSLATE},(t,s)=>{const i=this.props.item();return i.props.onClick=this.handlePopoutClose.bind(this),s.isShown&&(i.props.selected=!0),i})}}function G(){document.querySelector(`.${N}`)?.style.setProperty("--darken-opacity",new String(n.persist.ghost.opacity??.3))}function y(){document.querySelector(`.${N}`)?.removeAttribute("style")}const[ce,he,de,ue,we,me,Ne,{default:Ge,DefaultColorButton:xe,CustomColorButton:De,CustomColorPicker:_e},Ue,Ie,Le]=a.batchFind(e=>{e.findByDisplayName("FormItem"),e.findByDisplayName("FormText"),e.findByDisplayName("FormDivider"),e.findByDisplayName("Flex"),e.findByDisplayName("TextInput"),e.findByDisplayName("Slider"),e.findByDisplayName("SelectTempWrapper"),e.find(t=>t.default?.displayName==="ColorPicker"&&!t.default.defaultProps),e.findByDisplayName("Tooltip"),e.findByDisplayName("Popout"),e.findByProps("Sizes","Colors","Looks","DropdownSizes")}),Ee=S.webpack.findByProps("dividerDefault").dividerDefault;var x=({className:e})=>r.createElement(de,{className:[Ee,e].join(" ")});const g={...S.webpack.findByProps("marginBottom20"),...S.webpack.findByProps("formText"),...ue};var D=({title:e,required:t,className:s,note:i,divider:o=!0,children:d}={})=>r.createElement(ce,{title:e,required:t,className:[g.marginBottom20,s].join(" ")},d,i&&r.createElement(he,{className:`${g.description} ${g.marginTop8}`},i),o&&r.createElement(x,{className:[g.marginTop20].join(" ")}));function E(e){const t=e.children;return delete e.children,r.createElement(D,{title:t,note:e.note,required:e.required},r.createElement(me,{...e}))}a.findByProps("hex2int");const l={...a.findByProps("wrapper","base"),...a.findByProps("flex"),...a.findByProps("size20"),...a.findByProps("marginBottom20"),...a.findByProps("dividerDefault")},ye=a.findByDisplayName("ArrowDropDown"),ge=a.findByDisplayName("ArrowDropUp"),fe=a.findByDisplayName("LegacyText");var _=({opened:e,className:t,children:s,title:i,onClick:o})=>(Array.isArray(s)||(s=[s]),r.createElement("div",{className:t},r.createElement("div",{style:{width:"100%"},onClick:()=>o?.(),className:[l.flex,l.alignCenter,l.marginBottom8].join(" ")},e?r.createElement(ge,{className:l.base,width:32,height:32}):r.createElement(ye,{className:l.base,width:32,height:32}),r.createElement(fe,{className:[l.base,l.size16,l.marginLeft8].join(" ")},i)),e?r.createElement("div",{className:[l.marginLeft8,l.marginBottom20].join(" ")},[...s]):null,!e&&r.createElement(x,{className:l.marginBottom20})));const Se=a.findByDisplayName("RadioGroup");var C=e=>{const t=e.children;return delete e.children,r.createElement(D,{title:t,note:e.note,required:e.required},r.createElement(Se,{...e}))},U=a.findByDisplayName("SwitchItem");const[{MESSAGE_GROUP_SPACING:Pe,DEFAULT_COMPACT_SPACING:I,DEFAULT_COZY_SPACING:L},{MessageDisplayCompact:Te}]=a.batchFind(e=>{e.findByProps("MESSAGE_GROUP_SPACING"),e.findByProps("MessageDisplayCompact")});var ve=()=>{const[e,t]=r.useState({0:!1,1:!1});R.useNest(n.persist);const s=Te.getSetting(),i=(o,d)=>Object.fromEntries(Object.entries(o).map(c=>(c[0]===d&&!c[1]?c[1]=!0:c[1]=!1,c)));return r.createElement("div",null,r.createElement(_,{opened:e[0],title:"Trigger",onClick:()=>t(o=>i(o,"0"))},r.createElement(C,{value:n.persist.ghost.displayOn||"hover",options:[{name:"Hover",value:"hover"},{name:"Mouse Wheel Click",value:"mwheel"}],onChange:o=>n.persist.store.displayOn=o.value},"Display Preview On"),r.createElement(E,{stickToMarkers:!0,disabled:(n.persist.ghost.displayOn||"hover")!=="hover",initialValue:n.persist.ghost.delay||.3,defaultValue:.3,markers:[.2,.3,.4,.5,.7,1,1.5,2,2.5,3,3.5,4],onMarkerRender:o=>o+"s",onValueChange:o=>n.persist.store.delay=o},"Hover Delay")),r.createElement(_,{opened:e[1],title:"Appearance",onClick:()=>t(o=>i(o,"1"))},r.createElement(C,{value:n.persist.ghost.displayMode||"sync",options:[{name:"Cozy",value:"cozy"},{name:"Compact",value:"compact"},{name:"Sync with Client",value:"sync"}],onChange:o=>n.persist.store.displayMode=o.value},"Display Message"),r.createElement(C,{value:n.persist.ghost.groupSpacing??"sync",options:[{name:"Custom",value:"custom"},{name:"Sync with Client",value:"sync"}],onChange:o=>n.persist.store.groupSpacing=o.value},"Space Between Messages"),r.createElement(E,{disabled:(n.persist.ghost.groupSpacing||"sync")!=="custom",markers:Pe,stickToMarkers:!0,onMarkerRender:o=>o+"px",defaultValue:s?I:L,initialValue:n.persist.ghost.groupSpacingNum??s?I:L,onValueChange:o=>n.persist.store.groupSpacingNum=o},"Space Between Message Groups"),r.createElement(E,{note:"Sets the opacity level of darkening layer.",defaultValue:.3,initialValue:n.persist.ghost.opacity??.3,onValueChange:o=>n.persist.store.opacity=o,markers:[.1,.2,.3,.4,.4,.5,.6,.7,.8,.9,1],stickToMarkers:!0},"Darken Level"),r.createElement(E,{note:"Sets popouts's window height in percentages relative to Discord's window height.",defaultValue:30,initialValue:n.persist.ghost.hpopout||30,onValueChange:o=>{n.persist.store.hpopout=o,M.setVars()},markers:[10,20,30,40,50,60,70,80,90,100],stickToMarkers:!0},"Popout Height"),r.createElement(E,{note:"Sets popouts's window width in percentages relative to Discord's window width.",defaultValue:40,initialValue:n.persist.ghost.wpopout||40,onValueChange:o=>{n.persist.store.wpopout=o,M.setVars()},markers:[10,20,30,40,50,60,70,80,90,100],stickToMarkers:!0},"Popout Width"),r.createElement(U,{note:"Shows who's typing in previewed channel.",value:n.persist.ghost.typingUsers??!0,onChange:()=>n.persist.store.typingUsers=!n.persist.ghost.typingUsers},"Show Typing Users"),r.createElement(U,{note:"Shows tabs for the Channel Preview popout and Threads popout",value:n.persist.ghost.tabs??!0,onChange:()=>n.persist.store.tabs=!n.persist.ghost.tabs},"Show Tabs")))},Ce=()=>u.injectCSS('.cc-ChannelPreview{margin-top:5px;min-height:150px;min-width:300px;height:var(--popout-height);width:var(--popout-width);background-color:var(--background-primary);overflow-x:hidden;overflow-y:auto;border-radius:10px;padding-bottom:10px}.cc-ChannelPreviewThreadPopout>[class*=popout]{margin-top:42px;left:0}.cc-ChannelPreview li{list-style-type:none}.cc-ChannelPreview:before{content:"";border-radius:10px;position:absolute;top:0;left:0;width:100%;height:50px;background:linear-gradient(to bottom,var(--background-primary),transparent);z-index:20}.cc-ChannePreviewDivider{margin-top:1.5rem;margin-bottom:.5rem}.cc-ChannelPreviewTyping>[class*=typing]{position:initial}');const[Me,Ae]=a.batchFind(e=>{e.findByDisplayName("ConnectedTextChannel",!1),e.findByDisplayName("ChannelItem",!1)}),f=[],Be=`
.${a.findByProps("chat").chat} {
  --darken-opacity: 1;
  opacity: var(--darken-opacity);
  transition: 0.3s opacity;
}`;var M={onLoad(){f.push(u.after("default",Me,function([{channel:e}],t){let s=u.after("render",t.type.DecoratedComponent.prototype,(i,o)=>(e.type===0&&o.props?.children?.props?.children&&!o.props?.children?.props?.res&&(o.props.children=r.createElement(pe,{res:o,item:o.props.children.props.children,channelId:e.id})),s(),o),!0);return t})),f.push(u.after("default",Ae,(e,t)=>{if(n.persist.ghost.displayOn==="mwheel"){const s=O(t);s?.ref?.current&&(s.ref.current.onauxclick=i=>i.preventDefault())}return t})),f.push(Ce(),u.injectCSS(Be)),this.setVars()},onUnload(){y(),this.setVars(!0),f.forEach(e=>e?.())},settings:ve,setVars(e){e&&(document.body.style.removeProperty("--popout-height"),document.body.style.removeProperty("--popout-width")),document.body.style.setProperty("--popout-height",`${n.persist.ghost.hpopout||30}vh`),document.body.style.setProperty("--popout-width",`${n.persist.ghost.wpopout||40}vh`)}};function O(e){let t=null;for(const s in e)e[s]&&typeof e[s]=="object"&&(e[s].props?.onClick&&e[s].props?.role==="link"?t=e[s]??t:be(s)&&(t=O(e[s])??t));return t}function be(e){return e==="props"||e==="children"||!isNaN(e)}return M})(cumcord.modules.common.React,cumcord.modules.webpack,cumcord.patcher,cumcord.pluginData,cumcord.modules.common,cumcord.modules.internal.nests,cumcord.utils,cumcord.modules);
