(function(R,a,c,n,V,l,d,S){"use strict";function $(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(s){if(s!=="default"){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}}),t.default=e,Object.freeze(t)}var r=$(R);const[{generateMessageSpecs:j,default:q}]=a.batchFind(e=>{e.findByProps("generateMessageSpecs")});var z=({amount:e})=>{const[t,s]=r.useState(null);return r.useEffect(()=>{s(j({compact:!1,fontSize:16,messageGroups:e,groupSpacing:16,groupRange:3}))},[]),t?r.createElement(q,{compact:!1,messages:t.messages,attachmentSpecs:t.attachmentSpecs,totalHeight:t.totalHeight,groupSpacing:t.groupSpacing}):null};const[{default:H},{getMessages:A,getMessage:B},{fetchMessages:W},{divider:Y,hasContent:Z,content:J},{divider:K},{MessageDisplayCompact:b},Q,{thin:X},{tabBar:ee,tabBarItem:w},{DEFAULT_COMPACT_SPACING:te,DEFAULT_COZY_SPACING:se},{EmptyStateText:re,default:ne},oe,ie,m]=a.batchFind(e=>{e.findByProps("ThreadStarterChatMessage"),e.findByProps("getMessages"),e.findByProps("sendBotMessage"),e.findByProps("divider","isUnread"),e.findByProps("divider","hasContent"),e.findByProps("MessageDisplayCompact"),e.findByProps("messageGroupSpacing"),e.findByProps("thin"),e.findByProps("tabBar","tabBarItem"),e.findByProps("MESSAGE_GROUP_SPACING"),e.findByProps("EmptyStateText"),e.findByDisplayName("FluxContainer(TypingUsers)"),e.findByDisplayName("ActiveThreadsPopout"),e.findByDisplayName("TabBar")}),ae=l.constants.MESSAGE_GROUP_INTERVAL/1e3,P=l.constants.MessageTypes;let v;class pe extends r.PureComponent{constructor(t){super(),this.ref=r.createRef();const s=A(t.channel.id);this.state={messages:s.length===0&&s.ready?null:s.toArray().reverse().slice(0,20).reverse(),tab:"MESSAGES"},this.MESSAGE_CREATE=this.MESSAGE_CREATE.bind(this),this.MESSAGE_UPDATE=this.MESSAGE_UPDATE.bind(this),this.MESSAGE_DELETE=this.MESSAGE_DELETE.bind(this),this.scrollToBottom=this.scrollToBottom.bind(this)}componentDidMount(){this.state.messages?.length===0?W({channelId:this.props.channel.id,limit:20})?.then(t=>{if(!t)return this.setState({messages:null});const s=A(this.props.channel.id).toArray().reverse().slice(0,20).reverse();if(s.length===0)return this.setState({messages:null});this.setState({messages:s}),this.scrollToBottom()}):this.scrollToBottom(),l.FluxDispatcher.subscribe("MESSAGE_CREATE",this.MESSAGE_CREATE),l.FluxDispatcher.subscribe("MESSAGE_UPDATE",this.MESSAGE_UPDATE),l.FluxDispatcher.subscribe("MESSAGE_DELETE",this.MESSAGE_DELETE)}componentWillUnmount(){l.FluxDispatcher.unsubscribe("MESSAGE_CREATE",this.MESSAGE_CREATE),l.FluxDispatcher.unsubscribe("MESSAGE_UPDATE",this.MESSAGE_UPDATE),l.FluxDispatcher.unsubscribe("MESSAGE_DELETE",this.MESSAGE_DELETE)}MESSAGE_CREATE(t){this.props.channel.id===t.channelId&&(this.setState(s=>({messages:[...s.messages,B(this.props.channel.id,t.message.id)]})),this.scrollToBottom())}MESSAGE_UPDATE(t){this.props.channel.id===t.message.channel_id&&this.setState(s=>{const i=s.messages.findIndex(o=>o.id===t.message.id);if(!(i<0))return s[i]=B(channel.id,t.message.id),s})}scrollToBottom(){this.ref.current&&(this.ref.current.scrollTop=this.ref.current.scrollHeight)}MESSAGE_DELETE(t){this.props.channel.id===t.channelId&&this.setState(s=>{const i=s.messages.findIndex(o=>o.id===t.id);if(!(i<0))return delete s.messages[i],{...t,messages:[...s.messages.filter(o=>o)]}})}getGroupId(t){const s=this.state.messages.indexOf(t)===0?null:this.state.messages[this.state.messages.indexOf(t)-1];return s?t.author.id!==s.author.id||t.type!==P.DEFAULT||![P.DEFAULT,P.REPLY].includes(s.type)||Math.abs(s.timestamp.unix()-t.timestamp.unix())>ae||!t.timestamp.isSame(s.timestamp,"day")?v=t.id:v:v=t.id}sortMessages(){const{messages:t}=this.state,s=[];return t.forEach(i=>{const o=this.getGroupId(i),u=t.indexOf(i)===0?null:t[t.indexOf(i)-1];(!u||!i.timestamp.isSame(u.timestamp,"day"))&&s.push(r.createElement(le,{timestamp:i.timestamp}));const h=(n.persist.ghost.displayMode||"sync")==="sync"?b.getSetting():n.persist.ghost.displayMode==="compact";s.push(r.createElement(H,{compact:h,channel:this.props.channel,message:i,groupId:o,id:`chat-messages-${i.id}`}))}),s}renderMessagesPopout(){const t=(n.persist.ghost.displayMode||"sync")==="sync"?b.getSetting():n.persist.ghost.displayMode==="compact",s=n.persist.ghost.groupSpacing??"sync"?Q.messageGroupSpacing:n.persist.ghost.groupSpacingNum??t?te:se;return r.createElement("div",{className:["cc-ChannelPreview",`group-spacing-${s}`,X].join(" "),ref:this.ref},this.state.messages?this.state.messages.length===0?r.createElement(z,{amount:10}):r.createElement("div",{className:"cc-ChannelPreviewTyping"},this.sortMessages(),(n.persist.ghost.typingUsers??!0)&&r.createElement(oe,{channel:this.props.channel})):r.createElement(ne,null,r.createElement(re,{note:"This channel has no messages"})))}renderThreadPopout(){return r.createElement("div",{className:"cc-ChannelPreviewThreadPopout"},r.createElement(ie,{...this.props.popout,channel:this.props.channel}))}renderContent(){if(this.state.tab==="MESSAGES")return this.renderMessagesPopout();if(this.state.tab==="THREADS")return this.renderThreadPopout()}render(){return r.createElement("div",{onMouseEnter:this.props.onMouseEnter,onMouseLeave:this.props.onMouseLeave},(n.persist.ghost.tabs??!0)&&!this.props.dm&&r.createElement(m,{className:["cc-ChannelPreviewTabBar",ee].join(" "),selectedItem:this.state.tab,onItemSelect:t=>this.setState({tab:t}),look:m.Looks.BRAND,type:m.Types.TOP},r.createElement(m.Item,{className:w,id:"MESSAGES"},"Messages"),r.createElement(m.Item,{className:w,id:"THREADS"},"Threads")),this.renderContent())}}const le=({timestamp:e})=>r.createElement("div",{className:[Y,Z,K,"cc-ChannePreviewDivider"].join(" "),"aria-label":e.format("LL"),role:"separator"},r.createElement("span",{className:J},e.format("LL"))),[T,{chat:N},{container:x},{getChannel:ce}]=a.batchFind(e=>{e.findByDisplayName("Popout"),e.findByProps("chat"),e.findByProps("tabBody"),e.findByProps("getDMFromUserId")});class G extends r.PureComponent{constructor(t){super(),this.state={show:!1},this.enterTimer=0,this.exitTimer=0,this.channel=ce(t.channelId),this.nestUpdate=this.nestUpdate.bind(this),this.handleMouseEnter=this.handleMouseEnter.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handlePopoutOpen=this.handlePopoutOpen.bind(this)}nestUpdate(){this.forceUpdate()}componentDidMount(){try{n.persist.on(d.Events.UPDATE,this.nestUpdate),n.persist.on(d.Events.SET,this.nestUpdate),n.persist.on(d.Events.DELETE,this.nestUpdate)}catch{}}componentWillUnmount(){f(),n.persist.off(d.Events.UPDATE,this.nestUpdate),n.persist.off(d.Events.SET,this.nestUpdate),n.persist.off(d.Events.DELETE,this.nestUpdate)}handleMouseEnter(){this.resetPopoutTimers(),this.channel.id!==l.channels.getChannelId()&&(this.enterTimer=setTimeout(()=>{this.setState({show:!0}),setTimeout(()=>_())},(n.persist.ghost.delay||.3)*1e3))}handleMouseLeave(){this.resetPopoutTimers(),this.exitTimer=setTimeout(()=>{this.setState({show:!1}),f()},300)}handlePopoutClose(){this.resetPopoutTimers(),this.setState({show:!1}),f()}handlePopoutOpen(){this.resetPopoutTimers(),this.channel.id!==l.channels.getChannelId()&&(this.setState({show:!0}),setTimeout(()=>_(),this.state.show?300:0))}renderPopout(t){return r.createElement(pe,{popout:t,dm:this.props.dm,onMouseEnter:this.handlePopoutOpen,onMouseLeave:this.handleMouseLeave,channel:this.channel})}resetPopoutTimers(){clearTimeout(this.enterTimer),clearTimeout(this.exitTimer)}render(){return(n.persist.ghost.displayOn||"hover")==="hover"?(this.props.res.props.onMouseEnter=this.handleMouseEnter,this.props.res.props.onMouseDown=null,this.props.dm&&setTimeout(()=>{this.props.res.ref.current&&(this.props.res.ref.current.onauxclick=null)})):(this.props.res.props.onMouseDown=t=>t.button===1&&this.handlePopoutOpen(),this.props.res.props.onMouseEnter=()=>this.state.show&&this.handlePopoutOpen(),this.props.dm&&setTimeout(()=>{this.props.res.ref.current&&(this.props.res.ref.current.onauxclick=t=>t.preventDefault())})),this.props.res.props.onMouseLeave=this.handleMouseLeave,r.createElement(T,{nudgeAlignIntoViewport:!0,autoInvert:!0,renderPopout:this.renderPopout.bind(this),shouldShow:!!this.state.show,spacing:20,onRequestClose:this.handlePopoutClose.bind(this),align:T.Align.CENTER,animation:T.Animation.TRANSLATE},(t,s)=>{const i=this.props.item?.()||this.props.res;return i.props.onClick=this.handlePopoutClose.bind(this),s.isShown&&(i.props.selected=!0),i})}}function _(){document.querySelector(`.${N}`)?.style.setProperty("--darken-opacity",new String(n.persist.ghost.opacity??.3)),document.querySelector(`.${x}`)?.style.setProperty("--darken-opacity",new String(n.persist.ghost.opacity??.3))}function f(){document.querySelector(`.${N}`)?.removeAttribute("style"),document.querySelector(`.${x}`)?.removeAttribute("style")}const[he,de,ue,me,xe,Ee,Ge,{default:_e,DefaultColorButton:De,CustomColorButton:Ue,CustomColorPicker:Ie},Le,Oe,Fe]=a.batchFind(e=>{e.findByDisplayName("FormItem"),e.findByDisplayName("FormText"),e.findByDisplayName("FormDivider"),e.findByDisplayName("Flex"),e.findByDisplayName("TextInput"),e.findByDisplayName("Slider"),e.findByDisplayName("SelectTempWrapper"),e.find(t=>t.default?.displayName==="ColorPicker"&&!t.default.defaultProps),e.findByDisplayName("Tooltip"),e.findByDisplayName("Popout"),e.findByProps("Sizes","Colors","Looks","DropdownSizes")}),ye=S.webpack.findByProps("dividerDefault").dividerDefault;var D=({className:e})=>r.createElement(ue,{className:[ye,e].join(" ")});const g={...S.webpack.findByProps("marginBottom20"),...S.webpack.findByProps("formText"),...me};var U=({title:e,required:t,className:s,note:i,divider:o=!0,children:u}={})=>r.createElement(he,{title:e,required:t,className:[g.marginBottom20,s].join(" ")},u,i&&r.createElement(de,{className:`${g.description} ${g.marginTop8}`},i),o&&r.createElement(D,{className:[g.marginTop20].join(" ")}));function E(e){const t=e.children;return delete e.children,r.createElement(U,{title:t,note:e.note,required:e.required},r.createElement(Ee,{...e}))}a.findByProps("hex2int");const p={...a.findByProps("wrapper","base"),...a.findByProps("flex"),...a.findByProps("size20"),...a.findByProps("marginBottom20"),...a.findByProps("dividerDefault")},fe=a.findByDisplayName("ArrowDropDown"),ge=a.findByDisplayName("ArrowDropUp"),Se=a.findByDisplayName("LegacyText");var I=({opened:e,className:t,children:s,title:i,onClick:o})=>(Array.isArray(s)||(s=[s]),r.createElement("div",{className:t},r.createElement("div",{style:{width:"100%"},onClick:()=>o?.(),className:[p.flex,p.alignCenter,p.marginBottom8].join(" ")},e?r.createElement(ge,{className:p.base,width:32,height:32}):r.createElement(fe,{className:p.base,width:32,height:32}),r.createElement(Se,{className:[p.base,p.size16,p.marginLeft8].join(" ")},i)),e?r.createElement("div",{className:[p.marginLeft8,p.marginBottom20].join(" ")},[...s]):null,!e&&r.createElement(D,{className:p.marginBottom20})));const Pe=a.findByDisplayName("RadioGroup");var C=e=>{const t=e.children;return delete e.children,r.createElement(U,{title:t,note:e.note,required:e.required},r.createElement(Pe,{...e}))},L=a.findByDisplayName("SwitchItem");const[{MESSAGE_GROUP_SPACING:ve,DEFAULT_COMPACT_SPACING:O,DEFAULT_COZY_SPACING:F},{MessageDisplayCompact:Te}]=a.batchFind(e=>{e.findByProps("MESSAGE_GROUP_SPACING"),e.findByProps("MessageDisplayCompact")});var Ce=()=>{const[e,t]=r.useState({0:!1,1:!1});V.useNest(n.persist);const s=Te.getSetting(),i=(o,u)=>Object.fromEntries(Object.entries(o).map(h=>(h[0]===u&&!h[1]?h[1]=!0:h[1]=!1,h)));return r.createElement("div",null,r.createElement(I,{opened:e[0],title:"Trigger",onClick:()=>t(o=>i(o,"0"))},r.createElement(C,{value:n.persist.ghost.displayOn||"hover",options:[{name:"Hover",value:"hover"},{name:"Mouse Wheel Click",value:"mwheel"}],onChange:o=>n.persist.store.displayOn=o.value},"Display Preview On"),r.createElement(E,{stickToMarkers:!0,disabled:(n.persist.ghost.displayOn||"hover")!=="hover",initialValue:n.persist.ghost.delay||.3,defaultValue:.3,markers:[.2,.3,.4,.5,.7,1,1.5,2,2.5,3,3.5,4],onMarkerRender:o=>o+"s",onValueChange:o=>n.persist.store.delay=o},"Hover Delay")),r.createElement(I,{opened:e[1],title:"Appearance",onClick:()=>t(o=>i(o,"1"))},r.createElement(C,{value:n.persist.ghost.displayMode||"sync",options:[{name:"Cozy",value:"cozy"},{name:"Compact",value:"compact"},{name:"Sync with Client",value:"sync"}],onChange:o=>n.persist.store.displayMode=o.value},"Display Message"),r.createElement(C,{value:n.persist.ghost.groupSpacing??"sync",options:[{name:"Custom",value:"custom"},{name:"Sync with Client",value:"sync"}],onChange:o=>n.persist.store.groupSpacing=o.value},"Space Between Messages"),r.createElement(E,{disabled:(n.persist.ghost.groupSpacing||"sync")!=="custom",markers:ve,stickToMarkers:!0,onMarkerRender:o=>o+"px",defaultValue:s?O:F,initialValue:n.persist.ghost.groupSpacingNum??s?O:F,onValueChange:o=>n.persist.store.groupSpacingNum=o},"Space Between Message Groups"),r.createElement(E,{note:"Sets the opacity level of darkening layer.",defaultValue:.3,initialValue:n.persist.ghost.opacity??.3,onValueChange:o=>n.persist.store.opacity=o,markers:[.1,.2,.3,.4,.4,.5,.6,.7,.8,.9,1],stickToMarkers:!0},"Darken Level"),r.createElement(E,{note:"Sets popouts's window height in percentages relative to Discord's window height.",defaultValue:30,initialValue:n.persist.ghost.hpopout||30,onValueChange:o=>{n.persist.store.hpopout=o,M.setVars()},markers:[10,20,30,40,50,60,70,80,90,100],stickToMarkers:!0},"Popout Height"),r.createElement(E,{note:"Sets popouts's window width in percentages relative to Discord's window width.",defaultValue:40,initialValue:n.persist.ghost.wpopout||40,onValueChange:o=>{n.persist.store.wpopout=o,M.setVars()},markers:[10,20,30,40,50,60,70,80,90,100],stickToMarkers:!0},"Popout Width"),r.createElement(L,{note:"Shows who's typing in previewed channel.",value:n.persist.ghost.typingUsers??!0,onChange:()=>n.persist.store.typingUsers=!n.persist.ghost.typingUsers},"Show Typing Users"),r.createElement(L,{note:"Shows tabs for the Channel Preview popout and Threads popout",value:n.persist.ghost.tabs??!0,onChange:()=>n.persist.store.tabs=!n.persist.ghost.tabs},"Show Tabs")))},Me=()=>c.injectCSS('.cc-ChannelPreview{margin-top:5px;min-height:150px;min-width:300px;height:var(--popout-height);width:var(--popout-width);background-color:var(--background-primary);overflow-x:hidden;overflow-y:auto;border-radius:10px;padding-bottom:10px}.cc-ChannelPreviewThreadPopout>[class*=popout]{margin-top:42px;left:0}.cc-ChannelPreview li{list-style-type:none}.cc-ChannelPreview:before{content:"";border-radius:10px;position:absolute;top:0;left:0;width:100%;height:50px;background:linear-gradient(to bottom,var(--background-primary),transparent);z-index:20}.cc-ChannePreviewDivider{margin-top:1.5rem;margin-bottom:.5rem}.cc-ChannelPreviewTyping>[class*=typing]{position:initial}');const[Ae,Be,be,ke]=a.batchFind(e=>{e.findByDisplayName("ConnectedTextChannel",!1),e.findByDisplayName("ChannelItem",!1),e.findByDisplayName("PrivateChannel"),e.findByProps("GuildChannelList")}),y=[],we=`
.${a.findByProps("chat").chat},
.${a.findByProps("tabBody").container} {
  --darken-opacity: 1;
  opacity: var(--darken-opacity);
  transition: 0.3s opacity;
}`;var M={onLoad(){y.push(c.after("default",Ae,function(e,t){let s=c.after("render",t.type.DecoratedComponent.prototype,function(i,o){return![15,14,4,13].includes(channel.type)&&o.props?.children?.props?.children&&!o.props?.children?.props?.res&&(o.props.children=r.createElement(G,{res:o,item:o.props.children.props.children,channelId:this.props.channel.id})),s(),o},!0);return t})),y.push(c.after("default",Be,(e,t)=>{if(n.persist.ghost.displayOn==="mwheel"){const s=k(t);s?.ref?.current&&(s.ref.current.onauxclick=i=>i.preventDefault())}return t})),y.push(c.after("render",be.prototype,(e,t)=>(c.after("children",t.props,(s,i)=>r.createElement(G,{res:i,dm:!0,channelId:t.props.id}),!0),t))),y.push(Me(),c.injectCSS(we)),this.setVars()},onUnload(){f(),this.setVars(!0),y.forEach(e=>e?.())},settings:Ce,setVars(e){e&&(document.body.style.removeProperty("--popout-height"),document.body.style.removeProperty("--popout-width")),document.body.style.setProperty("--popout-height",`${n.persist.ghost.hpopout||30}vh`),document.body.style.setProperty("--popout-width",`${n.persist.ghost.wpopout||40}vh`)}};function k(e){let t=null;for(const s in e)e[s]&&typeof e[s]=="object"&&(e[s].props?.onClick&&e[s].props?.role==="link"?t=e[s]??t:Ne(s)&&(t=k(e[s])??t));return t}function Ne(e){return e==="props"||e==="children"||!isNaN(e)}return M})(cumcord.modules.common.React,cumcord.modules.webpack,cumcord.patcher,cumcord.pluginData,cumcord.utils,cumcord.modules.common,cumcord.modules.internal.nests,cumcord.modules);
